@using Voltage.Entities.Entity;
@model IEnumerable<User>


<style>
    .rectangle {
        display: flex;
        flex-wrap: nowrap;
        overflow: hidden;   
        border-radius: 10px;
        background: lightgray;
        max-width: 680px;
        margin: 10px;
    }

    .voiceEfect {
        margin: 2px;
        border-radius: 30px;
        background: blue;
        min-width: 10px;
    }
</style>


<link rel="stylesheet" type="text/css" href="/css/Textanimate.css" />
<link rel="stylesheet" href="/css/PushDate.css"/>
<link href="/dist/libs/dropzone/dist/dropzone.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.2/min/dropzone.min.css" crossorigin="anonymous" />
<div class="page-body">
    <div class="container-xl">
        <div class="card">
            <div class="row g-0">
                <div id="MessageFriendList" class="col-12 col-lg-5 col-xl-3 border-end-wide">
                    <div class="card-header d-block d-md-block">
                        <div class="input-icon">
                            <span class="input-icon-addon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" /><path d="M21 21l-6 -6" /></svg>
                            </span>
                            <input type="text" value="" class="form-control mb-1" placeholder="Search…" aria-label="Search" />
                        </div>
                    </div>
                    <div class="card-body p-0 scrollable" style="max-height: 35rem;">
                        <div class="nav flex-column nav-pills" role="tablist">
                            @foreach (var item in Model)
                            {
                                <a href="#chat-@item.UserName" onclick="clickToUser('@item.UserName')" class="nav-link text-start mw-100 p-3" id="chat-@item.UserName-tab" data-bs-toggle="pill" role="tab" aria-selected="true" data-user-name="@item.UserName" data-user-photo="@item.Photo" data-user-status="Online">
                                    <div class="row align-items-center flex-fill">
                                        <div class="col-auto">
                                            <span class="avatar" style="background-image: url('@item.Photo')"></span>
                                        </div>
                                        <div class="col text-body">
                                            <div>@item.UserName</div>
                                            <div id="lastMessage" class="text-secondary text-truncate w-100"></div>
                                        </div>
                                    </div>
                                </a>
                            }
                        </div>
                    </div>
                </div>
                <div id="messageAreas1" class="col-12 col-lg-7 col-xl-9 d-flex flex-column hide-on-small-screen">
                    <div class="patterns" id="animationtext">
                        <svg width="100%" height="100%">
                            <defs>
                                
                            </defs>          
                            <rect x="0" y="0" width="100%" height="100%" fill="url(#polka-dots)"> </rect>
                            <text x="50%" y="60%"  text-anchor="middle"  >
                                Voltage 🗲
                            </text> 
                        </svg>
                    </div>
                    <div id="MessageSection" class="displaynone">
                        <div id="chatHeader" class="card-header d-flex justify-content-between align-items-center">
                            <div  class="d-flex align-items-center">
                                <div class="col-auto mx-3 backbtn">
                                    <button id="backMsgFriendlist" onclick="backFriendList()" class="btn btn-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-circle-arrow-left-filled" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M12 2a10 10 0 0 1 .324 19.995l-.324 .005l-.324 -.005a10 10 0 0 1 .324 -19.995zm.707 5.293a1 1 0 0 0 -1.414 0l-4 4a1.048 1.048 0 0 0 -.083 .094l-.064 .092l-.052 .098l-.044 .11l-.03 .112l-.017 .126l-.003 .075l.004 .09l.007 .058l.025 .118l.035 .105l.054 .113l.043 .07l.071 .095l.054 .058l4 4l.094 .083a1 1 0 0 0 1.32 -1.497l-2.292 -2.293h5.585l.117 -.007a1 1 0 0 0 -.117 -1.993h-5.586l2.293 -2.293l.083 -.094a1 1 0 0 0 -.083 -1.32z" stroke-width="0" fill="currentColor" /></svg>
                                    </button>
                                </div>
                                <div class="col-auto mx-2">
                                    <span class="avatar" style="background-image: url()"></span>
                                </div>
                                <div class="col-auto ms-2">
                                    <h4 class="mb-2"></h4>
                                    <h5 class="mb-0">
                                    </h5>
                                </div>
                            </div>
                            <div class="d-flex col-auto">
                                <a href="#" class="link-secondary me-3" data-bs-toggle="tooltip" aria-label="Clear search" title="Clear search">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-phone-call" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M5 4h4l2 5l-2.5 1.5a11 11 0 0 0 5 5l1.5 -2.5l5 2v4a2 2 0 0 1 -2 2a16 16 0 0 1 -15 -15a2 2 0 0 1 2 -2" /><path d="M15 7a2 2 0 0 1 2 2" /><path d="M15 3a6 6 0 0 1 6 6" /></svg>
                                </a>
                                <a href="#" class="link-secondary me-2" data-bs-toggle="tooltip" aria-label="Clear search" title="Clear search">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-video" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M15 10l4.553 -2.276a1 1 0 0 1 1.447 .894v6.764a1 1 0 0 1 -1.447 .894l-4.553 -2.276v-4z" /><path d="M3 6m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z" /></svg>
                                </a>
                            </div>
                        </div>
                        <div class="text-center mt-5"> 
                            <div id="stylishDiv" class="badge bg-purple text-purple-fg">
                                Custom Tarix
                            </div>
                        </div>
                        <div id="overChatBubbles" class="card-body scrollable" style="height: 35rem">
                            <div class="chat">
                                <div class="chat-bubbles"></div>
                            </div>
                        </div>
                        <div id="chat-footer" class="card-footer">
                            <div id="chat-inputs" class="input-group input-group-flat">
                                <div class="rectangle"></div>
                                    <span id="dropbtnstate" class="input-group-text">
                                        <div class="dropupbtn" onclick="toggleMenu()">
                                            <button type="button" class="link-secondary bg-transparent border-0 dropup-button">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                    <path d="M15 7l-6.5 6.5a1.5 1.5 0 0 0 3 3l6.5 -6.5a3 3 0 0 0 -6 -6l-6.5 6.5a4.5 4.5 0 0 0 9 9l6.5 -6.5" />
                                                </svg>
                                            </button>
                                            <div class="dropupbtn-content">
                                                <a href="#">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-file" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                        <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                                                        <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                                                    </svg>Documents
                                                </a>
                                                <a href="#">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-photo" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                                        <path d="M15 8h.01" />
                                                        <path d="M3 6a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v12a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3v-12z" />
                                                        <path d="M3 16l5 -5c.928 -.893 2.072 -.893 3 0l5 5" />
                                                        <path d="M14 14l1 -1c.928 -.893 2.072 -.893 3 0l3 3" />
                                                    </svg>Send Photo
                                                </a>
                                            </div>
                                        </div>
                                        <a href="#" class="link-secondary" data-bs-toggle="tooltip" aria-label="Clear search" title="Emojies">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M9 10l.01 0" /><path d="M15 10l.01 0" /><path d="M9.5 15a3.5 3.5 0 0 0 5 0" /></svg>
                                        </a>
                                    </span>
                                    <textarea class="form-control resize-none" rows="1" id="messageInput" placeholder="Type message" oninput="adjustTextareaRows()"></textarea>
                                    <span class="input-group-text">
                                        <a href="#" id="sendButton" class="link-secondary ms-2" data-bs-toggle="tooltip">
                                            <svg id="sendBtnIc" style="display:none;" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-send" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M10 14l11 -11" /><path d="M21 3l-6.5 18a.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a.55 .55 0 0 1 0 -1l18 -6.5" /></svg>
                                            <svg id="voiceBtnIc" onclick="startRecording()" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-microphone" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M9 2m0 3a3 3 0 0 1 3 -3h0a3 3 0 0 1 3 3v5a3 3 0 0 1 -3 3h0a3 3 0 0 1 -3 -3z" /><path d="M5 10a7 7 0 0 0 14 0" /><path d="M8 21l8 0" /><path d="M12 17l0 4" /></svg>
                                        </a>
                                    </span>
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.2/emojionearea.js" integrity="sha512-aGWPnmdBhJ0leVHhQaRASgb0InV/Z2BWsscdj1Vwt29Oic91wECPixuXsWESpFfCcYPLfOlBZzN2nqQdMxlGTQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.2/min/dropzone.min.js" integrity="sha512-VQQXLthlZQO00P+uEu4mJ4G4OAgqTtKG1hri56kQY1DtdLeIqhKUp9W/lllDDu3uN3SnUNawpW7lBda8+dSi7w==" crossorigin="anonymous"></script>
<script src="~/js/MessageClientSide.js"></script>
<script>
    //setTimeout(function () {
    //    var element = document.getElementById("stylishDiv");
    //    element.classList.add("hide");
    //}, 5000);

    




    let micIcon = document.getElementById('voiceBtnIc'), sendIcon = document.getElementById('sendBtnIc'),
        drpstate = document.getElementById("dropbtnstate");

    function adjustTextareaRows() {
        let textarea = document.getElementById('messageInput'),
            lineHeight = parseFloat(getComputedStyle(textarea).lineHeight), minRows = 1, maxRows = 3, maxHeight = maxRows * lineHeight,
            rows = 1, innerHeight = textarea.scrollHeight - parseFloat(getComputedStyle(textarea).paddingTop) - parseFloat(getComputedStyle(textarea).paddingBottom);


        if (textarea.value.length > 100)
            minRows = 2;

        if (textarea.value.trim() !== '') {
            rows = Math.min(Math.max(minRows, Math.ceil(textarea.scrollHeight / lineHeight)), maxRows);
            micIcon.style.display = "none";
            sendIcon.style.display = "inline-block";
        }
        else {
            micIcon.style.display = "inline-block";
            sendIcon.style.display = "none";
        }

        textarea.rows = rows;
        textarea.style.height = (rows * lineHeight) + 'px';


        if (innerHeight > maxHeight)
            textarea.style.overflowY = 'auto';
        else
            textarea.style.overflowY = 'hidden';
    }



    function toggleMenu() {
        let dropupBtn = document.querySelector('.dropupbtn');
        dropupBtn.classList.toggle('active');

        if (dropupBtn.classList.contains('active'))
            document.addEventListener('click', closeMenuOnClickOutside);
        else
            document.removeEventListener('click', closeMenuOnClickOutside);


        function closeMenuOnClickOutside(event) {
            if (!dropupBtn.contains(event.target)) {
                dropupBtn.classList.remove('active');
                document.removeEventListener('click', closeMenuOnClickOutside);
            }
        }
    }


    let voiceEfect, height, src, myElements, sampleRate, analyser, num = 52,
        array = new Uint8Array(num * 2), width = 10, context = null, isRecording = false;

    function startRecording() {
        //let chatinputs = document.getElementById("chat-inputs");
        //chatinputs.style.display = "none";
        let txtarea = document.getElementById("messageInput");
        txtarea.style.display = "none";
        drpstate.style.display = "none";
        sendIcon.style.display = "inline-block";
        if (!context) {
            let rectangle = document.querySelector('.rectangle');
            for (let i = 0; i < num; i++) {
                voiceEfect = document.createElement('div');
                voiceEfect.className = 'voiceEfect';
                rectangle.appendChild(voiceEfect);
            }

            myElements = document.getElementsByClassName('voiceEfect');
            context = new AudioContext();
            sampleRate = context.sampleRate;

            analyser = context.createAnalyser();

            navigator.mediaDevices.getUserMedia({
                audio: true
            }).then(stream => {
                src = context.createMediaStreamSource(stream);
                src.connect(analyser);
                loop();
            }).catch(error => {
                alert(error + '\r\n\ sondurulub reload ver');
                location.reload();
            });
        }
        isRecording = true;
    }

    function loop() {
        window.requestAnimationFrame(loop);
        analyser.getByteFrequencyData(array);
        if (isRecording) {
            for (var i = 0; i < num; i++) {
                height = Math.max(array[i + num], 5);
                myElements[i].style.height = height * 0.1 + 'px';
                myElements[i].style.opacity = 0.008 * height;
            }
        }
    }

</script>